<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Login - Sistema de Viaturas</title>

<!-- Ãcone e Manifest -->
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" type="image/png" href="icons/icon-192.png">

<!-- iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Viaturas">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<!-- Cores -->
<meta name="theme-color" content="#004aad">
<meta name="background-color" content="#004aad">

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
:root {
  --azul-marinha:#004aad; --azul-hover:#003b8e;
  --fundo:#f5f7fa; --texto:#1f2937;
  --branco:#ffffff; --borda:#d1d5db;
  --sombra:rgba(0,0,0,0.1);
}
*{box-sizing:border-box;margin:0;padding:0;font-family:"Segoe UI",Roboto,Arial,sans-serif;}
body{
  background:linear-gradient(135deg,var(--azul-marinha),#0a58ca);
  display:flex;justify-content:center;align-items:center;
  min-height:100vh;padding:20px;
}
.card{
  background:var(--branco);border-radius:12px;
  box-shadow:0 6px 20px var(--sombra);
  padding:40px 30px;text-align:center;
  max-width:380px;width:100%;
}
.logo{width:90px;margin-bottom:15px;}
h2{color:var(--azul-marinha);margin-bottom:25px;}
input{
  width:100%;padding:12px;margin-bottom:14px;
  border:1px solid var(--borda);border-radius:8px;
  background-color:#f9fafb;font-size:15px;
}
button{
  width:100%;padding:12px;border:none;border-radius:8px;
  font-size:16px;font-weight:600;cursor:pointer;
  margin-top:5px;transition:background 0.3s;
}
button.primary{background-color:var(--azul-marinha);color:var(--branco);}
button.primary:hover{background-color:var(--azul-hover);}
button.google{
  background:#fff;border:1px solid #dadce0;color:#3c4043;
  display:flex;align-items:center;justify-content:center;gap:8px;
  margin-top:10px;
}
button.google img{width:20px;height:20px;}
p.hint{margin-top:16px;font-size:14px;}
p.hint a{color:var(--azul-marinha);text-decoration:none;font-weight:500;}
p.hint a:hover{text-decoration:underline;}
.update-banner{
  display:none;margin-top:20px;padding:10px;border-radius:8px;
  background:#0e1a2d;color:white;border:1px solid #2753a3;
}
</style>
</head>

<body>
  <div class="card">
    <img class="logo" src="https://raw.githubusercontent.com/netcodebr/vtrteste/refs/heads/main/heraldica-8DN.png" alt="Marinha do Brasil">
    <h2>Sistema de Viaturas</h2>

    <input type="email" id="email" placeholder="Email institucional" required />
    <input type="password" id="senha" placeholder="Senha" required />
    <button class="primary" onclick="login()">Entrar</button>

    <div style="margin:12px 0;font-size:14px;color:#555;">ou</div>
    <button class="google" id="btnGoogle">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" />
      Entrar com Google
    </button>

    <p class="hint"><a href="cadastro.html">NÃ£o tem cadastro? Clique aqui</a></p>

    <div id="updateBanner" class="update-banner">
      ðŸš€ Nova versÃ£o disponÃ­vel! 
      <button onclick="atualizarAgora()" style="background:#004aad;color:white;border:none;padding:5px 10px;border-radius:4px;">Atualizar</button>
    </div>
  </div>

<!-- Service Worker -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js").then(reg => {
    reg.addEventListener("updatefound", () => {
      const novo = reg.installing;
      novo.addEventListener("statechange", () => {
        if (novo.state === "installed" && navigator.serviceWorker.controller) {
          document.getElementById("updateBanner").style.display = "block";
        }
      });
    });
  });
}
function atualizarAgora() {
  navigator.serviceWorker.getRegistration().then(r => {
    if (r && r.waiting) r.waiting.postMessage("SKIP_WAITING");
  });
  location.reload();
}
</script>

<!-- Firebase Login + SweetAlert2 de mÃºltiplas funÃ§Ãµes -->
<script type="module">
import { auth, db } from "./firebase-config.js";
import {
  signInWithEmailAndPassword,
  GoogleAuthProvider,
  signInWithPopup
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

// ===== LOGIN COM EMAIL E SENHA =====
window.login = async () => {
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha").value;
  if (!email || !senha) return Swal.fire("Preencha todos os campos", "", "warning");

  try {
    const cred = await signInWithEmailAndPassword(auth, email, senha);
    await redirecionarUsuario(cred.user.uid);
  } catch (e) {
    Swal.fire("Erro de login", e.message, "error");
  }
};

// ===== LOGIN COM GOOGLE =====
document.getElementById("btnGoogle").addEventListener("click", async () => {
  try {
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });
    const result = await signInWithPopup(auth, provider);
    const user = result.user;

    const ref = doc(db, "usuarios", user.uid);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      const roles = await escolherRolesComSwal(); // SeleÃ§Ã£o mÃºltipla

      await setDoc(ref, {
        nome: user.displayName || "UsuÃ¡rio Google",
        email: user.email,
        roles,
        aprovado: false,
        criado_em: serverTimestamp()
      });

      await Swal.fire({
        icon: "success",
        title: "Cadastro criado!",
        html: `FunÃ§Ãµes selecionadas:<br><b>${roles.join(", ")}</b><br><br>Aguarde aprovaÃ§Ã£o do administrador.`,
        confirmButtonText: "OK",
        confirmButtonColor: "#004aad"
      });
      return;
    }

    const dados = snap.data();
    if (!dados.aprovado)
      return Swal.fire("Aguardando aprovaÃ§Ã£o", "Seu cadastro ainda nÃ£o foi aprovado pelo administrador.", "info");

    await redirecionarUsuario(user.uid);
  } catch (err) {
    console.error(err);
    Swal.fire("Erro", err.message || String(err), "error");
  }
});

// ===== SWEETALERT2 ESTILIZADO (MÃšLTIPLAS FUNÃ‡Ã•ES) =====
async function escolherRolesComSwal() {
  const { value: roles } = await Swal.fire({
    title: '<span style="color:#004aad;font-weight:700;">Selecione suas funÃ§Ãµes</span>',
    html: `
      <style>
        .swal2-popup.custom-modal {
          border-radius: 14px !important;
          background: linear-gradient(180deg, #f9fafc, #eef3f9);
          box-shadow: 0 0 25px rgba(0,0,0,0.2);
        }
        .funcoes-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px 25px;
          text-align: left;
          margin-top: 10px;
        }
        .funcoes-item {
          background: white;
          border: 2px solid #cbd5e1;
          border-radius: 10px;
          padding: 10px 14px;
          display: flex;
          align-items: center;
          gap: 10px;
          transition: 0.25s;
        }
        .funcoes-item:hover {
          border-color: #004aad;
          background: #f0f7ff;
          transform: translateY(-1px);
        }
        .funcoes-item input {
          width: 18px;
          height: 18px;
          accent-color: #004aad;
          cursor: pointer;
        }
        .funcoes-item label {
          font-size: 15px;
          color: #1e293b;
          cursor: pointer;
        }
        .swal2-confirm.custom-confirm {
          background-color: #004aad !important;
          color: #fff !important;
          font-weight: 600 !important;
          border-radius: 8px !important;
          padding: 10px 0 !important;
        }
        .swal2-cancel.custom-cancel {
          background-color: #64748b !important;
          color: #fff !important;
          font-weight: 600 !important;
          border-radius: 8px !important;
          padding: 10px 0 !important;
        }
      </style>

      <div class="funcoes-grid">
        <div class="funcoes-item"><input type="checkbox" class="role" value="motorista" id="rMotorista"><label for="rMotorista">ðŸš— Motorista</label></div>
        <div class="funcoes-item"><input type="checkbox" class="role" value="auxiliar" id="rAux"><label for="rAux">ðŸ§¾ Auxiliar do Encarregado</label></div>
        <div class="funcoes-item"><input type="checkbox" class="role" value="encarregado" id="rEnc"><label for="rEnc">ðŸ§­ Encarregado</label></div>
        <div class="funcoes-item"><input type="checkbox" class="role" value="ose" id="rOSE"><label for="rOSE">ðŸ“œ OSE</label></div>
        <div class="funcoes-item"><input type="checkbox" class="role" value="chefe" id="rChefe"><label for="rChefe">âš“ Chefe de Departamento</label></div>
      </div>
    `,
    width: 600,
    background: "#ffffff",
    customClass: {
      popup: "custom-modal",
      confirmButton: "custom-confirm",
      cancelButton: "custom-cancel"
    },
    showCancelButton: true,
    confirmButtonText: "Confirmar",
    cancelButtonText: "Cancelar",
    focusConfirm: false,
    preConfirm: () => {
      const selecionadas = Array.from(document.querySelectorAll(".role:checked")).map(i => i.value);
      if (selecionadas.length === 0) {
        Swal.showValidationMessage("Selecione pelo menos uma funÃ§Ã£o");
        return false;
      }
      if (selecionadas.includes("adm")) {
        Swal.showValidationMessage("FunÃ§Ã£o ADM Ã© restrita");
        return false;
      }
      return selecionadas;
    }
  });

  if (!roles) throw new Error("OperaÃ§Ã£o cancelada");
  return roles;
}

// ===== REDIRECIONAMENTO =====
async function redirecionarUsuario(uid) {
  const uDoc = await getDoc(doc(db, "usuarios", uid));
  if (!uDoc.exists()) throw new Error("UsuÃ¡rio sem cadastro.");
  const u = uDoc.data();
  if (!u.aprovado) throw new Error("UsuÃ¡rio ainda nÃ£o aprovado.");

  const funcoes = Array.isArray(u.roles) ? u.roles : [u.role];
  const rotas = {
    adm: "adm-dashboard.html",
    encarregado: "encarregado-dashboard.html",
    auxiliar: "aux-encarregado-dashboard.html",
    ose: "ose-dashboard.html",
    chefe: "chefe-dashboard.html",
    motorista: "motorista-dashboard.html"
  };

  const primeira = funcoes.find(r => rotas[r]);
  if (primeira) window.location.href = rotas[primeira];
  else window.location.href = "index.html";
}
</script>
</body>
</html>
