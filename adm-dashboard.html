<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Administrador - Dashboard</title>
<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/netcodebr/vtrteste/refs/heads/main/heraldica-8DN.png">

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<!-- html2canvas + jsPDF para exportar PDF -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
/* =======================
   RESET + BASE
======================= */
* { margin:0; padding:0; box-sizing:border-box; font-family:"Inter","Segoe UI",Roboto,sans-serif; }
body { background:linear-gradient(180deg,#e9ecf4 0%,#f5f7fa 100%); color:#1b1b1b; min-height:100vh; }

/* =======================
   HEADER
======================= */
header { background:#001f3f; color:#fff; display:flex; align-items:center; justify-content:space-between; padding:14px 28px; border-bottom:5px solid #c9a600; box-shadow:0 3px 10px rgba(0,0,0,0.25); }
.logo-marinha { display:flex; align-items:center; gap:14px; }
.logo-marinha img { width:50px; height:50px; }
header h1 { font-size:1.35rem; font-weight:600; letter-spacing:0.5px; }
header button { background:linear-gradient(145deg,#b30000,#800000); border:none; color:#fff; font-weight:600; padding:8px 18px; border-radius:6px; cursor:pointer; transition:0.25s; }
header button:hover { transform:scale(1.05); background:linear-gradient(145deg,#cc0000,#990000); }

/* =======================
   NAV TABS
======================= */
.nav-tabs { display:flex; justify-content:center; flex-wrap:wrap; background:#f0f2f6; box-shadow:inset 0 -1px 0 #ccc; }
.nav-tabs button { flex:1; min-width:160px; background:none; border:none; padding:14px 18px; font-weight:600; text-transform:uppercase; color:#002b5c; cursor:pointer; transition:all 0.25s ease; letter-spacing:0.4px; }
.nav-tabs button:hover { background:#dde3f0; color:#001d3d; }
.nav-tabs button.active { background:#002b5c; color:#fff; box-shadow:inset 0 -4px 0 #c9a600; }

/* =======================
   CONTAINER E SE√á√ïES
======================= */
.container { max-width:1300px; margin:30px auto; padding:0 24px; }
.tab-pane { background:#fff; border-radius:10px; padding:28px; box-shadow:0 4px 15px rgba(0,0,0,0.1); animation:fadeIn 0.3s ease; }
@keyframes fadeIn { from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }
h2 { color:#002b5c; margin-bottom:20px; font-weight:700; border-left:6px solid #c9a600; padding-left:10px; display:flex; align-items:center; gap:10px; }

/* =======================
   TABELAS
======================= */
.table-wrap { overflow-x:auto; border-radius:8px; }
table { width:100%; border-collapse:collapse; border-radius:8px; overflow:hidden; }
thead { background:#002b5c; color:#fff; }
th, td { padding:12px 16px; border-bottom:1px solid #ddd; text-align:left; font-size:0.95rem; }
tbody tr:hover { background:#f7f9fc; transition:0.2s; }

/* =======================
   BOT√ïES DE A√á√ÉO
======================= */
.actions button { margin:3px; padding:6px 10px; font-size:0.85rem; border:none; border-radius:6px; cursor:pointer; transition:all 0.2s; font-weight:500; }
.actions button:hover { transform:scale(1.07); }
button.aprovar { background:#2e7d32; color:#fff; }
button.desaprovar { background:#b71c1c; color:#fff; }
button.editar { background:#1565c0; color:#fff; }
button.reset { background:#fbc02d; color:#1b1b1b; }
button.excluir { background:#d32f2f; color:#fff; }
button.primary { background:#002b5c; color:#fff; }

/* =======================
   BADGES
======================= */
.badge-ok { background:#2e7d32; color:#fff; padding:3px 8px; border-radius:5px; font-size:0.8rem; }
.badge-no { background:#b71c1c; color:#fff; padding:3px 8px; border-radius:5px; font-size:0.8rem; }
.tag-fp { background:#ff6f00; color:#fff; padding:2px 6px; font-size:0.75rem; border-radius:4px; margin-left:4px; font-weight:600; }

/* =======================
   GRID/CHARTS
======================= */
.grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
.card { background:#fff; border:1px solid #e8e8e8; border-radius:10px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,0.06); }
.card h3 { color:#002b5c; margin-bottom:8px; font-size:1.05rem; }
.actions-bar { display:flex; gap:10px; margin-bottom:12px; flex-wrap:wrap; }

/* =======================
   RESPONSIVIDADE
======================= */
@media (max-width: 900px) {
  header { flex-direction:column; gap:8px; text-align:center; }
  .nav-tabs button { min-width:120px; font-size:0.8rem; }
  table th, table td { font-size:0.85rem; padding:8px; }
  .grid { grid-template-columns:1fr; }
}
</style>
</head>

<body>
<div class="container">
  <header>
    <div class="logo-marinha">
      <img src="https://raw.githubusercontent.com/netcodebr/vtrteste/refs/heads/main/heraldica-8DN.png" alt="Marinha do Brasil">
      <h1>Administrador ‚Äî Sistema de Viaturas</h1>
    </div>
    <button onclick="logout()">Sair</button>
  </header>

  <div class="nav-tabs">
    <button class="active" data-tab="tab-adm" onclick="setTab('tab-adm', this)">Usu√°rios ADM</button>
    <button data-tab="tab-chefe" onclick="setTab('tab-chefe', this)">Usu√°rios Chefes</button>
    <button data-tab="tab-ose" onclick="setTab('tab-ose', this)">Usu√°rios OSE</button>
    <button data-tab="tab-encarregado" onclick="setTab('tab-encarregado', this)">Usu√°rios Encarregados</button>
    <button data-tab="tab-aux" onclick="setTab('tab-aux', this)">Usu√°rios Auxiliares</button>
    <button data-tab="tab-motorista" onclick="setTab('tab-motorista', this)">Usu√°rios Motoristas</button>
    <button data-tab="tab-missoes" onclick="setTab('tab-missoes', this)">Miss√µes</button>
    <button data-tab="tab-estatisticas" onclick="setTab('tab-estatisticas', this)">Estat√≠sticas & Relat√≥rios</button>
    <button data-tab="tab-permissoes" onclick="setTab('tab-permissoes', this)">Permiss√µes</button>
    <button data-tab="tab-logs" onclick="setTab('tab-logs', this)">Logs</button>
    <button data-tab="tab-emulacao" onclick="setTab('tab-emulacao', this)">Emula√ß√£o</button>
  </div>

  <!-- ======== Usu√°rios (6 grupos) ======== -->
  <section id="tab-adm" class="tab-pane" style="display:block;"><h2>Usu√°rios ADM (0)</h2><div class="table-wrap"><table><thead><tr><th>Nome</th><th>Email</th><th>Cargos</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="usuarios-adm"></tbody></table></div></section>
  <section id="tab-chefe" class="tab-pane" style="display:none;"><h2>Usu√°rios Chefes (0)</h2><div class="table-wrap"><table><thead><tr><th>Nome</th><th>Email</th><th>Cargos</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="usuarios-chefe"></tbody></table></div></section>
  <section id="tab-ose" class="tab-pane" style="display:none;"><h2>Usu√°rios OSE (0)</h2><div class="table-wrap"><table><thead><tr><th>Nome</th><th>Email</th><th>Cargos</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="usuarios-ose"></tbody></table></div></section>
  <section id="tab-encarregado" class="tab-pane" style="display:none;"><h2>Usu√°rios Encarregados (0)</h2><div class="table-wrap"><table><thead><tr><th>Nome</th><th>Email</th><th>Cargos</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="usuarios-encarregado"></tbody></table></div></section>
  <section id="tab-aux" class="tab-pane" style="display:none;"><h2>Usu√°rios Auxiliares (0)</h2><div class="table-wrap"><table><thead><tr><th>Nome</th><th>Email</th><th>Cargos</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="usuarios-aux"></tbody></table></div></section>
  <section id="tab-motorista" class="tab-pane" style="display:none;"><h2>Usu√°rios Motoristas (0)</h2><div class="table-wrap"><table><thead><tr><th>Nome</th><th>Email</th><th>Cargos</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="usuarios-motorista"></tbody></table></div></section>

  <!-- ======== Miss√µes ======== -->
  <section id="tab-missoes" class="tab-pane" style="display:none;">
    <h2 id="titulo-missoes">Miss√µes (0)</h2>
    <div class="actions-bar">
      <button class="primary" onclick="exportarRelatorioPDF()">üßæ Exportar Relat√≥rio (PDF)</button>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Miss√£o</th><th>Motorista</th><th>Viatura</th><th>Status</th>
            <th>Od√¥metro In√≠cio</th><th>Hor√°rio In√≠cio</th>
            <th>Od√¥metro Fim</th><th>Hor√°rio Fim</th>
            <th>Assinaturas</th><th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="missoes-body"></tbody>
      </table>
    </div>
  </section>

  <!-- ======== Estat√≠sticas & Relat√≥rios ======== -->
  <section id="tab-estatisticas" class="tab-pane" style="display:none;">
    <h2>Estat√≠sticas & Relat√≥rios</h2>
    <div class="grid" id="charts-container">
      <div class="card">
        <h3>üìä Viagens por Motorista</h3>
        <canvas id="chartMotoristas" height="200"></canvas>
      </div>
      <div class="card">
        <h3>ü•ß Miss√µes por Status</h3>
        <canvas id="chartStatus" height="200"></canvas>
      </div>
    </div>
    <div class="actions-bar" style="margin-top:14px;">
      <button class="primary" onclick="exportarRelatorioPDF()">üßæ Exportar Relat√≥rio (PDF)</button>
    </div>
  </section>

  <!-- ======== Permiss√µes ======== -->
  <section id="tab-permissoes" class="tab-pane" style="display:none;">
    <h2>Permiss√µes</h2>
    <div class="card">
      <p>As permiss√µes determinam quais a√ß√µes aparecem e podem ser executadas. Voc√™ pode sobrescrever no Firestore criando/alterando o doc <code>config/permissoes</code>.</p>
      <p><b>Exemplo de doc:</b></p>
      <pre style="background:#f7f7f7; padding:10px; border-radius:8px; overflow:auto;">
{
  "usuarios": {"aprovar": true, "desaprovar": true, "editar": true, "resetar": true, "excluir": true},
  "missoes":  {"editar": true, "alterar_status": true},
  "relatorios": {"exportar_pdf": true}
}
      </pre>
      <div class="actions-bar">
        <button class="primary" onclick="mostrarPermissoesAtuais()">üëÅ Ver permiss√µes ativas</button>
      </div>
    </div>
  </section>

  <!-- ======== Logs ======== -->
  <section id="tab-logs" class="tab-pane" style="display:none;">
    <h2>Logs do Sistema</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>A√ß√£o</th><th>Alvo</th><th>Feito por</th><th>Data/Hora</th></tr></thead>
        <tbody id="logs-body"></tbody>
      </table>
    </div>
  </section>

  <!-- ======== Emula√ß√£o ======== -->
  <section id="tab-emulacao" class="tab-pane" style="display:none;">
    <h2>Emula√ß√£o de Perfil</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Nome</th><th>Email</th><th>Cargos</th><th>A√ß√£o</th></tr></thead>
        <tbody id="emulacao-body"></tbody>
      </table>
    </div>
  </section>
</div>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { collection, onSnapshot, doc, updateDoc, deleteDoc, getDoc, addDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

/* =======================
   SESS√ÉO / ABA / LOG
======================= */
const LIMITE = 10*60*1000; let t;
onAuthStateChanged(auth, async (u)=>{
  if(!u){ return window.location.href="index.html"; }
  const uDoc = await getDoc(doc(db,"usuarios", u.uid));
  const data = uDoc.exists() ? uDoc.data() : null;
  const roles = data ? (Array.isArray(data.roles) ? data.roles.map(r=>String(r).toLowerCase()) : [String(data.role||"").toLowerCase()]) : [];
  if(!data || (!roles.includes("adm"))){
    await signOut(auth); window.location.href="index.html"; return;
  }
  await carregarPermissoes();
  init();
  reset();
  ["mousemove","keydown","click","scroll","touchstart"].forEach(e=>document.addEventListener(e, reset));
});
function reset(){ clearTimeout(t); t=setTimeout(async()=>{ await signOut(auth); window.location.href="index.html"; }, LIMITE); }
window.logout = async()=>{ await signOut(auth); window.location.href="index.html"; };

window.setTab = (id, btn)=>{
  document.querySelectorAll(".tab-pane").forEach(p=>p.style.display="none");
  document.getElementById(id).style.display="block";
  document.querySelectorAll(".nav-tabs button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
};

async function logAction(acao, alvo, extra={}) {
  try {
    await addDoc(collection(db,"logs"), {
      acao, alvo,
      feito_por_uid: auth.currentUser?.uid || null,
      feito_por_email: auth.currentUser?.email || null,
      data_hora: serverTimestamp(), ...extra
    });
  } catch(e){ console.warn("Falha ao gravar log:", e); }
}

/* =======================
   PERMISS√ïES (AVAN√áADO)
======================= */
let PERMISSOES = {
  usuarios: { aprovar:true, desaprovar:true, editar:true, resetar:true, excluir:true },
  missoes:  { editar:true, alterar_status:true },
  relatorios: { exportar_pdf:true }
};
async function carregarPermissoes(){
  try{
    const cfg = await getDoc(doc(db,"config","permissoes"));
    if(cfg.exists()){
      const data = cfg.data();
      PERMISSOES = {
        usuarios: { ...PERMISSOES.usuarios, ...(data.usuarios||{}) },
        missoes:  { ...PERMISSOES.missoes,  ...(data.missoes||{}) },
        relatorios:{ ...PERMISSOES.relatorios, ...(data.relatorios||{}) }
      };
    }
  }catch(e){ console.warn("Sem doc config/permissoes. Usando default."); }
}
function can(path){
  const [grupo,acao] = path.split(".");
  return !!(PERMISSOES[grupo] && PERMISSOES[grupo][acao]);
}
window.mostrarPermissoesAtuais = ()=>{
  Swal.fire({
    title:"Permiss√µes ativas",
    html:`<pre style="text-align:left;white-space:pre-wrap">${JSON.stringify(PERMISSOES,null,2)}</pre>`,
    width:600
  });
};

/* =======================
   INICIALIZA√á√ÉO
======================= */
function init(){
  carregarUsuarios();
  carregarMissoesRealtime();
  carregarLogsRealtime();
  carregarEmulacaoRealtime();
}

/* =======================
   USU√ÅRIOS (SEPARADO POR ROLE + CONTAGEM)
======================= */
function carregarUsuarios(){
  const grupos = {
    adm:         { tbody: document.getElementById("usuarios-adm"),         titulo: "Usu√°rios ADM" },
    chefe:       { tbody: document.getElementById("usuarios-chefe"),       titulo: "Usu√°rios Chefes" },
    ose:         { tbody: document.getElementById("usuarios-ose"),         titulo: "Usu√°rios OSE" },
    encarregado: { tbody: document.getElementById("usuarios-encarregado"), titulo: "Usu√°rios Encarregados" },
    aux:         { tbody: document.getElementById("usuarios-aux"),         titulo: "Usu√°rios Auxiliares" },
    motorista:   { tbody: document.getElementById("usuarios-motorista"),   titulo: "Usu√°rios Motoristas" }
  };

  onSnapshot(collection(db,"usuarios"),(snap)=>{
    const count = { adm:0, chefe:0, ose:0, encarregado:0, aux:0, motorista:0 };
    Object.values(grupos).forEach(g=>g.tbody.innerHTML="");

    snap.forEach(d=>{
      const u = d.data();

      // ‚úÖ Suporte a 'role' (string) e 'roles' (array)
      const cargos = Array.isArray(u.roles)
        ? u.roles.map(r => String(r).toLowerCase())
        : [String(u.role||"").toLowerCase()];

      let grupo = null;
      if (cargos.includes("adm")) grupo = "adm";
      else if (cargos.includes("chefe")) grupo = "chefe";
      else if (cargos.includes("ose")) grupo = "ose";
      else if (cargos.includes("encarregado")) grupo = "encarregado";
      else if (cargos.includes("aux_encarregado") || cargos.includes("aux")) grupo = "aux";
      else if (cargos.includes("motorista")) grupo = "motorista";
      if(!grupo) return;

      count[grupo]++;
      const cargosTexto = Array.isArray(u.roles) ? u.roles.join(", ") : (u.role || "-");

      const aAprovar   = can("usuarios.aprovar")   ? `<button class="aprovar"   onclick="aprovar('${d.id}')">‚úî Aprovar</button>` : "";
      const aDesaprovar= can("usuarios.desaprovar")? `<button class="desaprovar" onclick="desaprovar('${d.id}')">‚úñ Desaprovar</button>` : "";
      const aEditar    = can("usuarios.editar")    ? `<button class="editar"    onclick="editarUsuario('${d.id}','${(u.nome||'').replace(/\"/g,'&quot;')}','${cargosTexto.replace(/\"/g,'&quot;')}')">‚úè Editar</button>` : "";
      const aReset     = can("usuarios.resetar")   ? `<button class="reset"     onclick="resetSenha('${u.email||''}')">üîÅ Resetar Senha</button>` : "";
      const aExcluir   = can("usuarios.excluir")   ? `<button class="excluir"   onclick="excluirUsuario('${d.id}')">üóë Excluir</button>` : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.nome||"-"}</td>
        <td>${u.email||"-"}</td>
        <td>${cargosTexto}</td>
        <td>${u.aprovado?'<span class="badge-ok">Aprovado</span>':'<span class="badge-no">Pendente</span>'}</td>
        <td class="actions">
          ${aAprovar}${aDesaprovar}${aEditar}${aReset}${aExcluir}
        </td>`;
      grupos[grupo].tbody.appendChild(tr);
    });

    // Atualiza t√≠tulos com contagem
    for(const [k,g] of Object.entries(grupos)){
      const h2 = g.tbody.closest("section").querySelector("h2");
      h2.textContent = `${g.titulo} (${count[k]})`;
    }
  });
}

/* === A√á√ïES DE USU√ÅRIOS (SweetAlert2) === */
window.aprovar = async(uid)=>{
  if(!can("usuarios.aprovar")) return Swal.fire("Sem permiss√£o","A√ß√£o n√£o permitida.","error");
  const conf = await Swal.fire({ title:"Aprovar usu√°rio?", icon:"question", showCancelButton:true, confirmButtonText:"‚úî Aprovar" });
  if(!conf.isConfirmed) return;
  await updateDoc(doc(db,"usuarios",uid), {aprovado:true});
  await logAction("Aprovar usu√°rio", uid);
  Swal.fire("‚úÖ Usu√°rio aprovado!", "", "success");
};
window.desaprovar = async(uid)=>{
  if(!can("usuarios.desaprovar")) return Swal.fire("Sem permiss√£o","A√ß√£o n√£o permitida.","error");
  const conf = await Swal.fire({ title:"Desaprovar usu√°rio?", icon:"warning", showCancelButton:true, confirmButtonText:"‚úñ Desaprovar" });
  if(!conf.isConfirmed) return;
  await updateDoc(doc(db,"usuarios",uid), {aprovado:false});
  await logAction("Desaprovar usu√°rio", uid);
  Swal.fire("Usu√°rio desaprovado!","","info");
};

/* ===== EDITAR USU√ÅRIO (m√∫ltiplas fun√ß√µes; bloqueia ADM) ===== */
window.editarUsuario = async(uid,nomeAtual,cargosAtuaisTexto="")=>{
  if(!can("usuarios.editar")) return Swal.fire("Sem permiss√£o","A√ß√£o n√£o permitida.","error");

  // Normaliza roles atuais
  const rolesAtuais = cargosAtuaisTexto
    ? cargosAtuaisTexto.split(",").map(r => r.trim().toLowerCase()).filter(Boolean)
    : [];

  // Se o usu√°rio-alvo j√° √© ADM, bloquear edi√ß√£o de roles (apenas nome)
  const isAlvoADM = rolesAtuais.includes("adm");

  const roleGridHTML = isAlvoADM
    ? `<div style="margin-top:8px; padding:10px; border-radius:8px; background:#fff3cd; color:#7a5b00; border:1px solid #ffe08a;">
         ‚ö† Este usu√°rio possui o papel <b>ADM</b>. As fun√ß√µes n√£o podem ser alteradas aqui.
       </div>`
    : `
      <div class="funcoes-grid" style="margin-top:10px">
        <div class="funcoes-item"><input type="checkbox" class="role" value="motorista" id="rMotorista"><label for="rMotorista">üöó Motorista</label></div>
        <div class="funcoes-item"><input type="checkbox" class="role" value="aux_encarregado" id="rAux"><label for="rAux">üßæ Auxiliar do Encarregado</label></div>
        <div class="funcoes-item"><input type="checkbox" class="role" value="encarregado" id="rEnc"><label for="rEnc">üß≠ Encarregado</label></div>
        <div class="funcoes-item"><input type="checkbox" class="role" value="ose" id="rOSE"><label for="rOSE">üìú OSE</label></div>
        <div class="funcoes-item"><input type="checkbox" class="role" value="chefe" id="rChefe"><label for="rChefe">‚öì Chefe de Departamento</label></div>
      </div>
    `;

  const { value: formValues } = await Swal.fire({
    title:'<span style="color:#004aad;font-weight:700;">Editar Usu√°rio</span>',
    html: `
      <style>
        .swal2-popup.custom-modal { border-radius: 14px !important; background: linear-gradient(180deg, #f9fafc, #eef3f9); box-shadow: 0 0 25px rgba(0,0,0,0.2); }
        .funcoes-item { background: white; border: 2px solid #cbd5e1; border-radius: 10px; padding: 10px 14px; display: flex; align-items: center; gap: 10px; transition: 0.25s; }
        .funcoes-item:hover { border-color: #004aad; background: #f0f7ff; transform: translateY(-1px); }
        .funcoes-item input { width: 18px; height: 18px; accent-color: #004aad; cursor: pointer; }
        .funcoes-item label { font-size: 15px; color: #1e293b; cursor: pointer; }
        .swal2-confirm.custom-confirm { background-color: #004aad !important; color: #fff !important; font-weight: 600 !important; border-radius: 8px !important; padding: 10px 0 !important; }
        .swal2-cancel.custom-cancel { background-color: #64748b !important; color: #fff !important; font-weight: 600 !important; border-radius: 8px !important; padding: 10px 0 !important; }
        .funcoes-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 25px; text-align: left; }
      </style>

      <input id="swal-nome" class="swal2-input" placeholder="Nome completo" value="${(nomeAtual||"").replace(/"/g,'&quot;')}" />
      ${roleGridHTML}
    `,
    width: 620,
    background: "#ffffff",
    customClass: { popup: "custom-modal", confirmButton: "custom-confirm", cancelButton: "custom-cancel" },
    showCancelButton: true,
    confirmButtonText: "üíæ Salvar",
    cancelButtonText: "Cancelar",
    focusConfirm: false,
    didOpen: () => {
      if (!isAlvoADM) {
        // Marca os roles atuais (exceto 'adm' que nem aparece)
        document.querySelectorAll(".role").forEach((cb) => {
          if (rolesAtuais.includes(cb.value)) cb.checked = true;
        });
      }
    },
    preConfirm: () => {
      const nome = document.getElementById("swal-nome").value.trim();
      if (!nome) { Swal.showValidationMessage("Preencha o nome corretamente."); return false; }

      if (isAlvoADM) {
        // N√£o alteramos roles de um usu√°rio que j√° √© ADM (somente nome)
        return { nome, roles: rolesAtuais };
      }

      const selecionadas = Array.from(document.querySelectorAll(".role:checked")).map(i => i.value);
      if (selecionadas.length === 0) { Swal.showValidationMessage("Selecione pelo menos uma fun√ß√£o."); return false; }
      if (selecionadas.includes("adm")) { Swal.showValidationMessage("Fun√ß√£o ADM √© restrita."); return false; }

      return { nome, roles: selecionadas };
    },
  });

  if (!formValues) return;

  // Atualiza o documento no Firestore (mant√©m compatibilidade com dashboards antigos usando 'role')
  await updateDoc(doc(db,"usuarios",uid), {
    nome: formValues.nome,
    roles: formValues.roles,
    role: formValues.roles[0] || null
  });

  await logAction("Editar usu√°rio", uid, { nome: formValues.nome, roles: formValues.roles });
  Swal.fire("‚úÖ Usu√°rio atualizado!", "", "success");
};

window.resetSenha = async(email)=>{
  if(!can("usuarios.resetar")) return Swal.fire("Sem permiss√£o","A√ß√£o n√£o permitida.","error");
  if(!email) return Swal.fire("Erro","Usu√°rio sem e-mail cadastrado.","error");
  const conf = await Swal.fire({ title:"Redefinir senha?", text:`Enviar e-mail para ${email}?`, icon:"question", showCancelButton:true, confirmButtonText:"üîÅ Enviar" });
  if(!conf.isConfirmed) return;
  try{ await sendPasswordResetEmail(auth,email); await logAction("Reset senha", email); Swal.fire("üìß Email enviado!","","success"); }
  catch(e){ Swal.fire("Erro","Falha ao enviar.","error"); }
};
window.excluirUsuario = async(uid)=>{
  if(!can("usuarios.excluir")) return Swal.fire("Sem permiss√£o","A√ß√£o n√£o permitida.","error");
  const conf = await Swal.fire({ title:"Excluir usu√°rio?", text:"A√ß√£o irrevers√≠vel.", icon:"warning", showCancelButton:true, confirmButtonText:"üóë Excluir", confirmButtonColor:"#d32f2f" });
  if(!conf.isConfirmed) return;
  await deleteDoc(doc(db,"usuarios",uid));
  await logAction("Excluir usu√°rio", uid);
  Swal.fire("üóë Usu√°rio exclu√≠do!","","success");
};

/* =======================
   MISS√ïES + CONTAGEM
======================= */
let MISSOES_CACHE = [];
function carregarMissoesRealtime(){
  onSnapshot(collection(db,"viaturas_missao"),(snap)=>{
    MISSOES_CACHE=[]; snap.forEach(d=>MISSOES_CACHE.push({id:d.id,...d.data()}));
    renderMissoes(MISSOES_CACHE);
    updateCharts(MISSOES_CACHE);
  });
}
function renderMissoes(list){
  const tbody=document.getElementById("missoes-body");
  if(!tbody) return;
  tbody.innerHTML="";
  list.forEach(m=>{
    const aEditar = can("missoes.editar") ? `<button class="editar" onclick="editarMissao('${m.id}')">‚úè Editar</button>` : "";
    const aStatus = can("missoes.alterar_status") ? `<button class="reset" onclick="alterarStatus('${m.id}')">‚Ü∫ Status</button>` : "";
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${m.missao||"-"} ${m.fora_programacao?'<span class="tag-fp">‚ö† Fora</span>':""}</td>
      <td>${m.motorista||"-"}</td>
      <td>${m.viatura_label||m.viatura||"-"}</td>
      <td>${m.status||"Pendente"}</td>
      <td>${m.odometro_inicio||"-"}</td>
      <td>${m.horario_inicio||"-"}</td>
      <td>${m.odometro_fim||"-"}</td>
      <td>${m.horario_fim||"-"}</td>
      <td>${(m.assinatura_ose||"-")}<br>${(m.assinatura_encarregado||"-")}<br>${(m.assinatura_chedep||"-")}</td>
      <td class="actions">${aEditar}${aStatus}</td>`;
    tbody.appendChild(tr);
  });
  const t = document.getElementById("titulo-missoes");
  if(t) t.textContent = `Miss√µes (${list.length})`;
}
window.editarMissao = async(id)=>{
  if(!can("missoes.editar")) return Swal.fire("Sem permiss√£o","A√ß√£o n√£o permitida.","error");
  const ref=doc(db,"viaturas_missao",id); const d=await getDoc(ref);
  if(!d.exists()) return Swal.fire("Erro","Miss√£o n√£o encontrada.","error");
  const m=d.data();
  const { value:v } = await Swal.fire({
    title:"Editar Miss√£o",
    html:`<input id="swal-missao" class="swal2-input" placeholder="Miss√£o" value="${m.missao||""}">
          <input id="swal-motorista" class="swal2-input" placeholder="Motorista" value="${m.motorista||""}">
          <input id="swal-viatura" class="swal2-input" placeholder="Viatura" value="${m.viatura_label||m.viatura||""}">`,
    showCancelButton:true, confirmButtonText:"Salvar",
    preConfirm:()=>{
      const missao=document.getElementById("swal-missao").value.trim();
      const motorista=document.getElementById("swal-motorista").value.trim();
      const viatura=document.getElementById("swal-viatura").value.trim();
      if(!missao||!motorista||!viatura){Swal.showValidationMessage("Preencha todos os campos"); return false;}
      return {missao,motorista,viatura};
    }
  });
  if(!v) return;
  await updateDoc(ref,{missao:v.missao,motorista:v.motorista,viatura_label:v.viatura});
  await logAction("Editar miss√£o", id);
  Swal.fire("Miss√£o atualizada!","","success");
};
window.alterarStatus = async(id)=>{
  if(!can("missoes.alterar_status")) return Swal.fire("Sem permiss√£o","A√ß√£o n√£o permitida.","error");
  const { value:status } = await Swal.fire({title:"Alterar status",input:"text",inputPlaceholder:"Ex: Conclu√≠da, Em viagem...",showCancelButton:true,confirmButtonText:"Salvar"});
  if(!status) return;
  await updateDoc(doc(db,"viaturas_missao",id),{status});
  await logAction("Alterar status miss√£o", id, {status});
  Swal.fire("Status atualizado!","","success");
};

/* =======================
   CHARTS (Chart.js)
======================= */
let chartMotoristas=null, chartStatus=null;

function aggregateByMotorista(missoes){
  const map=new Map();
  missoes.forEach(m=>{
    const k=(m.motorista||"Sem motorista").trim()||"Sem motorista";
    map.set(k,(map.get(k)||0)+1);
  });
  const arr=[...map.entries()].sort((a,b)=>b[1]-a[1]);
  const top=arr.slice(0,10);
  const outrosCount=arr.slice(10).reduce((s,[_k,v])=>s+v,0);
  if(outrosCount>0) top.push(["Outros", outrosCount]);
  return { labels: top.map(x=>x[0]), data: top.map(x=>x[1]) };
}
function aggregateByStatus(missoes){
  const map=new Map();
  missoes.forEach(m=>{
    const k=(m.status||"Pendente").trim()||"Pendente";
    map.set(k,(map.get(k)||0)+1);
  });
  const arr=[...map.entries()].sort((a,b)=>b[1]-a[1]);
  return { labels: arr.map(x=>x[0]), data: arr.map(x=>x[1]) };
}
function updateCharts(missoes){
  // Motoristas
  const mAgg=aggregateByMotorista(missoes);
  const ctxM=document.getElementById("chartMotoristas");
  if(ctxM){
    if(chartMotoristas) chartMotoristas.destroy();
    chartMotoristas=new Chart(ctxM, {
      type:"bar",
      data:{ labels:mAgg.labels, datasets:[{ label:"Viagens", data:mAgg.data, backgroundColor:"#1565c0" }]},
      options:{ responsive:true, plugins:{ legend:{ display:false }}, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 }}} }
    });
  }
  // Status
  const sAgg=aggregateByStatus(missoes);
  const ctxS=document.getElementById("chartStatus");
  if(ctxS){
    if(chartStatus) chartStatus.destroy();
    const colors=["#2e7d32","#1565c0","#ff6f00","#b71c1c","#6a1b9a","#00897b","#8d6e63","#455a64","#ffa000","#90a4ae"];
    chartStatus=new Chart(ctxS, {
      type:"doughnut",
      data:{ labels:sAgg.labels, datasets:[{ data:sAgg.data, backgroundColor: sAgg.labels.map((_,i)=>colors[i%colors.length]) }]},
      options:{ responsive:true, plugins:{ legend:{ position:"bottom" } } }
    });
  }
}

/* =======================
   RELAT√ìRIOS (PDF)
======================= */
window.exportarRelatorioPDF = async()=>{
  if(!can("relatorios.exportar_pdf")) return Swal.fire("Sem permiss√£o","A√ß√£o n√£o permitida.","error");
  const { jsPDF } = window.jspdf;
  const docPdf = new jsPDF({ unit:"pt", format:"a4" });
  const margin=40; let y=margin;

  const titulo="Relat√≥rio de Miss√µes";
  docPdf.setFont("helvetica","bold"); docPdf.setFontSize(16);
  docPdf.text(titulo, margin, y); y+=18;
  docPdf.setFont("helvetica","normal"); docPdf.setFontSize(10);
  docPdf.text(`Gerado em: ${new Date().toLocaleString()}`, margin, y); y+=14;

  // Sum√°rio
  const total= MISSOES_CACHE.length;
  const porStatus=aggregateByStatus(MISSOES_CACHE);
  docPdf.setFont("helvetica","bold"); docPdf.text("Sum√°rio:", margin, y); y+=14;
  docPdf.setFont("helvetica","normal");
  docPdf.text(`Total de miss√µes: ${total}`, margin, y); y+=14;
  porStatus.labels.forEach((st, i)=>{ docPdf.text(`- ${st}: ${porStatus.data[i]}`, margin, y); y+=12; });

  // Capturar charts
  const chartsDiv=document.getElementById("charts-container");
  if(chartsDiv){
    const canvasImg = await html2canvas(chartsDiv, { scale:1.5, backgroundColor:"#ffffff" });
    const imgData = canvasImg.toDataURL("image/png");
    const pageWidth=docPdf.internal.pageSize.getWidth()-margin*2;
    const imgW=pageWidth, imgH= (canvasImg.height/canvasImg.width)*imgW;
    y+=10;
    if(y+imgH>docPdf.internal.pageSize.getHeight()-margin){ docPdf.addPage(); y=margin; }
    docPdf.addImage(imgData,"PNG", margin, y, imgW, imgH);
    y+=imgH+10;
  }

  // Final
  docPdf.save(`relatorio_missoes_${new Date().toISOString().slice(0,10)}.pdf`);
  await logAction("Exportar relat√≥rio PDF","missoes");
  Swal.fire("‚úÖ Relat√≥rio exportado!","","success");
};

/* =======================
   LOGS
======================= */
function carregarLogsRealtime(){
  onSnapshot(query(collection(db,"logs"),orderBy("data_hora","desc")),(snap)=>{
    const tbody=document.getElementById("logs-body");
    if(!tbody) return;
    tbody.innerHTML="";
    snap.forEach(d=>{
      const l=d.data();
      const row={acao:l.acao||"",alvo:l.alvo||"",feito:l.feito_por_email||"",data:l.data_hora?.toDate?l.data_hora.toDate().toLocaleString():""};
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${row.acao}</td><td>${row.alvo}</td><td>${row.feito}</td><td>${row.data}</td>`;
      tbody.appendChild(tr);
    });
  });
}

/* =======================
   EMULA√á√ÉO
======================= */
function carregarEmulacaoRealtime(){
  const tbody=document.getElementById("emulacao-body");
  onSnapshot(collection(db,"usuarios"),(snap)=>{
    if(!tbody) return;
    tbody.innerHTML="";
    snap.forEach(d=>{
      const u=d.data();
      const cargosTexto = Array.isArray(u.roles) ? u.roles.join(", ") : (u.role || "-");
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${u.nome||"-"}</td><td>${u.email||"-"}</td><td>${cargosTexto}</td><td><button class="editar" onclick="emularPerfil('${u.email||''}','${cargosTexto.replace(/\"/g,'&quot;')}')">Emular</button></td>`;
      tbody.appendChild(tr);
    });
  });
}
window.emularPerfil=(email,cargosTexto)=>{
  if(!email) return Swal.fire("Erro","Usu√°rio inv√°lido.","error");
  const roles = cargosTexto.split(",").map(r=>r.trim().toLowerCase());
  const rotas = {
    adm:"adm-dashboard.html",
    chefe:"chefe-dashboard.html",
    ose:"ose-dashboard.html",
    encarregado:"encarregado-dashboard.html",
    motorista:"motorista-dashboard.html",
    "aux_encarregado":"aux-encarregado-dashboard.html",
    aux:"aux-encarregado-dashboard.html"
  };
  const primeiro = roles.find(r => rotas[r]);
  const destino = primeiro ? rotas[primeiro] : "index.html";
  Swal.fire({title:"Emular perfil?", text:`Voc√™ ser√° redirecionado como ${primeiro ? primeiro.toUpperCase() : "N/D"}.`, icon:"question", showCancelButton:true, confirmButtonText:"Sim"}).then(r=>{
    if(r.isConfirmed) window.location.href=`${destino}?emulando=${encodeURIComponent(email)}`;
  });
};
</script>
</body>
</html>
